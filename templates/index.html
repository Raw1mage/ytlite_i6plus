{% extends "base.html" %}

{% block content %}
{% if logged_in %}
<style>
    .chips-container {
        display: flex;
        gap: 10px;
        overflow-x: auto;
        padding: 10px 0;
        margin-bottom: 20px;
        -webkit-overflow-scrolling: touch;
        white-space: nowrap;
    }
    .chip {
        padding: 8px 16px;
        background: #333;
        border: 1px solid #444;
        border-radius: 20px;
        color: #fff;
        font-size: 14px;
        cursor: pointer;
        transition: background 0.2s;
    }
    .chip.active {
        background: #fff;
        color: #000;
        font-weight: bold;
    }
    .video-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
    }
    .video-card {
        background: #1e1e1e;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
    }
    .video-card img {
        width: 100%;
        aspect-ratio: 16/9;
        object-fit: cover;
        background: #000;
    }
    .video-card .info {
        padding: 10px;
    }
    .video-card .title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 5px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-height: 1.3;
        height: 2.6em; /* Fixed height for alignment */
    }
    .video-card .uploader {
        font-size: 12px;
        color: #aaa;
    }
    @media (max-width: 600px) {
        .video-grid {
            grid-template-columns: repeat(2, 1fr); /* 2 cols on mobile for better visibility */
            gap: 10px;
        }
    }
</style>

<div class="chips-container">
    <div class="chip active" onclick="loadCategory('all', this)">全部</div>
    <div class="chip" onclick="loadCategory('live', this)">直播中</div>
</div>

<div class="video-grid" id="video-grid">
    <!-- Videos injected via JS -->
</div>
<div id="loading" style="text-align: center; padding: 30px; color: #666; display: none;">
    Loading more videos...
</div>

<script>
    // Safe input listener
    const searchInput = document.querySelector("input[name=q]");
    if (searchInput) {
        searchInput.addEventListener("keydown", function(e) { 
            if (e.key === "Enter" && e.isComposing) { e.preventDefault(); } 
        });
    }

    let nextPageToken = '';
    let isLoading = false;
    let currentCategory = 'all';
    let isFinished = false;

    async function loadVideos(reset=false) {
        if (isLoading || (isFinished && !reset)) return;
        isLoading = true;
        document.getElementById('loading').style.display = 'block';
        
        if (reset) {
            document.getElementById('video-grid').innerHTML = '';
            nextPageToken = '';
            isFinished = false;
        }

        try {
            const response = await fetch(`/api/videos?pageToken=${nextPageToken}&category=${currentCategory}`);
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }
            const data = await response.json();
            
            if (data.videos && data.videos.length > 0) {
                const grid = document.getElementById('video-grid');
                data.videos.forEach(video => {
                    const div = document.createElement('div');
                    div.className = 'video-card';
                    div.onclick = function() { window.location.href = '/watch?v=' + video.id; };
                    div.innerHTML = `
                        <img src="${video.thumbnail}" loading="lazy">
                        <div class="info">
                            <div class="title">${video.title}</div>
                            <div class="uploader">${video.uploader}</div>
                        </div>
                    `;
                    grid.appendChild(div);
                });
                nextPageToken = data.nextPageToken || '';
                if (!nextPageToken) isFinished = true;
            } else {
                isFinished = true;
            }
        } catch (e) {
            console.error("Load error:", e);
        } finally {
            isLoading = false;
            document.getElementById('loading').style.display = 'none';
        }
    }

    function loadCategory(cat, element) {
        if (cat === currentCategory) return;
        currentCategory = cat;
        
        // UI update
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        element.classList.add('active');
        
        loadVideos(true);
    }

    // Infinite Scroll
    window.onscroll = function() {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
            loadVideos();
        }
    };

    // Initial Load
    loadVideos(true);
</script>

{% else %}
<!-- Not Logged In View -->
<div style="text-align: center; margin-top: 50px;">
    <h2 style="color: #aaa;">Search YouTube</h2>
    <form action="/search" method="get" class="search-box">
        <input type="search" name="q" placeholder="What do you want to watch?" required inputmode="search" enterkeyhint="search">
        <button type="submit">Go</button>
    </form>
    <div style="margin-top: 30px; font-size: 0.8em; color: #555;">Running on iPhone 6 Plus (iOS 12)</div>
</div>
{% endif %}
{% endblock %}
