{% extends "base.html" %}

{% block content %}
{% if logged_in %}
<!-- Video Feed -->
<div class="video-grid" id="video-grid">
    <!-- Videos injected via JS -->
</div>
<div id="loading" style="text-align: center; padding: 30px; color: #666; display: none;">
    Loading more videos...
</div>

<script>
    let nextPageToken = '';
    let isLoading = false;
    let currentCategory = 'all';
    let isFinished = false;

    async function loadVideos(reset = false) {
        if (isLoading || (isFinished && !reset)) return;
        isLoading = true;
        document.getElementById('loading').style.display = 'block';

        if (reset) {
            document.getElementById('video-grid').innerHTML = '';
            nextPageToken = '';
            isFinished = false;
        }

        try {
            let data;
            if (currentCategory === 'history') {
                if (reset) {
                    const history = getHistory(); // Defined in base.html
                    data = { videos: history, nextPageToken: '' };
                } else {
                    data = { videos: [], nextPageToken: '' };
                }
            } else {
                const response = await fetch(`/api/videos?pageToken=${nextPageToken}&category=${currentCategory}`);
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                data = await response.json();
                console.log('[loadVideos] category:', currentCategory, 'items:', data?.videos?.length || 0, 'error:', data?.error);
            }

            if (data.videos && data.videos.length > 0) {
                const grid = document.getElementById('video-grid');
                data.videos.forEach(video => {
                    const div = document.createElement('div');
                    div.className = 'video-card';
                    if (video.channel_id) div.setAttribute('data-channel', video.channel_id);
                    div.setAttribute('data-vid', video.id);
                    div.onclick = function () { openPlayer(video); }; // Defined in base.html
                    div.innerHTML = `
                        <img src="${video.thumbnail}" loading="lazy">
                        <div class="info">
                            <div class="title">${video.title}</div>
                            <div class="uploader">${video.uploader}</div>
                        </div>
                    `;
                    grid.appendChild(div);
                });
                nextPageToken = data.nextPageToken || '';
                if (!nextPageToken) isFinished = true;
            } else {
                isFinished = true;
            }
        } catch (e) {
            console.error("Load error:", e);
        } finally {
            isLoading = false;
            document.getElementById('loading').style.display = 'none';
        }
    }

    async function loadCategoryInternal(cat, element, refresh = false) {
        if (typeof closeOverlayIfOpen === 'function') closeOverlayIfOpen();

        if (element) {
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            if (!refresh) {
                element.classList.add('active');
            } else {
                const active = document.querySelector(`.chip[onclick*="'${currentCategory}'"]`);
                if (active) active.classList.add('active');
            }
        }

        if (!refresh && cat === currentCategory) return;

        currentCategory = cat;
        await loadVideos(true);
    }

    // Expose for base.html to call
    window.loadCategoryInternal = loadCategoryInternal;

    window.onload = function () {
        const urlParams = new URLSearchParams(window.location.search);
        const vid = urlParams.get('v');
        if (vid) {
            const dummyVideo = { id: vid, title: 'Loading...', uploader: 'Loading...', thumbnail: '' };
            if (typeof openPlayer === 'function') openPlayer(dummyVideo);
        }
        loadVideos(true);
    };

    // Infinite Scroll Logic
    window.onscroll = function () {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
            loadVideos();
        }
    };
</script>

{% else %}
<div style="text-align: center; margin-top: 50px;">
    <h2 style="color: #aaa;">Search YouTube</h2>
    <form action="/search" method="get" class="search-box">
        <input type="search" name="q" placeholder="What do you want to watch?" required inputmode="search"
            enterkeyhint="search">
        <button type="submit">Go</button>
    </form>
    <div style="margin-top: 30px; font-size: 0.8em; color: #555;">Running on iPhone 6 Plus (iOS 12) - v3.1</div>
</div>
{% endif %}
{% endblock %}